#VRML_SIM R2023b utf8
# license: Apache License 2.0
# license url: http://www.apache.org/licenses/LICENSE-2.0
# Model of a joint wheel of the robot TIAGo OMNI Base from PAL Robotics.
# tags: hidden
# template language: javascript

EXTERNPROTO "webots://projects/appearances/protos/GlossyPaint.proto"
EXTERNPROTO "webots://projects/appearances/protos/MattePaint.proto"

PROTO TiagoOmniBaseWheel [
  field  SFVec3f     translation     0 0 0
  field  SFRotation  rotation        0 0 1 0
  field  SFString{"wheel_front_right", "wheel_front_left", "wheel_rear_right", "wheel_rear_left"}
                     name            "wheel_front_right"
]
{
  %<
    const is_front = fields.name.value == "wheel_front_right" || fields.name.value == "wheel_front_left";
    const is_right = fields.name.value == "wheel_front_right" || fields.name.value == "wheel_rear_right";
    const front_string = is_front ? "front" : "rear";
    const right_string = is_right ? "right" : "left";
  >%
  Solid {
    translation IS translation
    rotation IS rotation
    children [
      DEF SUSPENSION Shape {
        appearance GlossyPaint {
          baseColor 0.79216 0.81961 0.93333
        }
        geometry Mesh {
          url %<= '"meshes/suspension_' + front_string + '.stl"' >%
        }
      }
      HingeJoint {
        jointParameters HingeJointParameters {
          %< if (!is_right) { >%
          axis 1 0 0
          %< } else { >%
          axis -1 0 0
          %< } >%
          anchor 0.050675 0 0
        }
        device [
          RotationalMotor {
            name %<= '"' + fields.name.value + '_joint"' >%
            maxVelocity 13.123
            maxTorque 6.0
          }
          PositionSensor {
            name %<= '"' + fields.name.value + '_joint_sensor"' >%
          }
        ]
        endPoint Solid {
          translation 0.050675 0 0
          %< if (is_right) { >%
          rotation -0.577350 -0.577350 0.577350 2.094395
          %< } else { >%
          rotation -0.577350 0.577350 -0.577350 2.094395
          %< } >%
          children [
          %< if (!is_right) { >%
            Transform {
              scale 1 1 -1
              children [
          %< } >%
                DEF WHEEL_SHAPE Shape {
                  appearance MattePaint {
                    baseColor 0.5 0.5 0.5
                  }
                  geometry Mesh {
                    url "meshes/wheel.stl"
                    %< if (!is_right) { >%
                      ccw FALSE
                    %< } >%
                  }
                }
          %< if (!is_right) { >%
              ]
            }
          %< } >%
          ]
          name %<= '"' + fields.name + '_link"' >%
          contactMaterial %<= '"TIAGo OMNI ' + right_string + ' wheel material"' >%
          boundingObject Cylinder {
            radius 0.0762
            height 0.05
          }
          physics Physics {
            density -1
            mass 0.707670
            centerOfMass [
            %< if (!is_right) { >%
              0 0 0.011144
            %< } else { >%
              0 0 -0.011144
            %< } >%
            ]
          }
        }
      }
    ]
    name %<= '"suspension_' + front_string + '_' + right_string + '_link"' >%
    boundingObject DEF SUSPENSION_BO Pose {
    translation -0.02 0 -0.007
      children [
        Box {
          size 0.07 0.15 0.05
        }
      ]
    }
    physics Physics {
      density -1
      mass 1.287900
      centerOfMass [ 
      %< if (!is_right) { >%
        -0.058182 0 -0.005770 
      %< } else { >%
        -0.058182 0 -0.005770 
      %< } >%
      ]
    }
  }
}