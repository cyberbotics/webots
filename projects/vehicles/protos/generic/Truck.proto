#VRML_SIM R2021a utf8
# license: Copyright Cyberbotics Ltd. Licensed for use only with Webots.
# license url: https://cyberbotics.com/webots_assets_license
# tags: static
# documentation url: https://www.cyberbotics.com/doc/automobile/car#heavy-weights
# A simple truck

PROTO Truck [
  field     SFVec3f    translation       0 0.5 0
  field     SFRotation rotation          0 1 0 0
  field     SFColor    color             0.39 0 0          # Defines the main color of the truck.
  field     SFNode     trailer           TruckTrailer { }  # Defines an optional trailer.
  field     SFFloat    wheelbase         5.25              # Defines the distance between the front and rear wheels.
  field     SFFloat    kingPinDistance   1.35              # Defines the distance (along the Z direction) between the rear wheel axis and the trailer rotation axis.
  field     SFFloat    mass              8000              # Defines the mass of the truck (trailer not included).
  field     SFString   name              "vehicle"         # Is `Solid.name`.
  field     SFString   controller        "void"            # Is `Robot.controller`.
  field     MFString   controllerArgs    [ ]               # Is `Robot.controllerArgs`.
  field     SFBool     supervisor        FALSE             # Is `Robot.supervisor`.
  field     SFBool     synchronization   TRUE              # Is `Robot.synchronization`.
  field     MFNode     sensorsSlotFront  [ ]               # Extends the truck with new nodes in the front slot.
  field     MFNode     sensorsSlotRear   [ ]               # Extends the truck with new nodes in the rear slot.
  field     MFNode     sensorsSlotTop    [ ]               # Extends the truck with new nodes in the top slot.
  field     MFNode     sensorsSlotCenter [ ]               # Extends the truck with new nodes in the center slot.
]
{
  %{
    local wheelbase = fields.wheelbase.value
    if wheelbase < 2.0 then
      wheelbase = 2.0
      io.stderr:write("'wheelbase' should not be smaller than 2.0.\n")
    end
  }%
  Car {
    translation IS translation
    rotation IS rotation
    name IS name
    controller IS controller
    controllerArgs IS controllerArgs
    supervisor IS supervisor
    synchronization IS synchronization
    trackFront 2.2
    trackRear 2.2
    wheelbase %{= wheelbase }%
    type "4x4"
    minSteeringAngle -0.4
    maxSteeringAngle 0.4
    suspensionFrontSpringConstant 1e+06
    suspensionFrontDampingConstant 10000
    suspensionRearSpringConstant 1e+06
    suspensionRearDampingConstant 10000
    wheelsDampingConstant 30
    model "truck"
    engineMinRPM 700
    engineMaxRPM 2250
    engineFunctionCoefficients -600 5.45 -0.0023  # calibrated for a torque of 2500Nm in the range [1000; 1350] RPM
    gearRatio [-14.77 16 13 11 9 7 6 4.5 3.7 3 2.4 1.9 1.5 1.2 1]
    extensionSlot [
      Transform {
        children IS sensorsSlotCenter
      }
      Transform {
        translation 0 1.1 6.75
        rotation 0 1 0 3.14159
        children IS sensorsSlotFront
      }
      Transform {
        translation 0 4.15 4.3
        rotation 0 1 0 3.14159
        children IS sensorsSlotTop
      }
      Transform {
        translation 0 2.7 -7.3
        children IS sensorsSlotRear
      }
      Transform {
        translation 0 0 %{= 0.998 * (wheelbase - 5.25) }%
        children [
          DEF FRONT_LIGHTS LED {  # VehicleLights are not used because of the trailer rotation and name duplication.
            children [
              TruckFrontLight {
              }
            ]
            name "front_lights"
            color 0.8 0.8 0.8
          }
        ]
      }
      Transform {
        translation 0 0 %{= fields.kingPinDistance.value }%
        children [
          DEF TRAILER_JOINT HingeJoint {
            jointParameters HingeJointParameters {
              axis 0 10 0
              minStop -1.3
              maxStop 1.3
              dampingConstant 10000
              staticFriction 1000
              suspensionAxis 0 1 0
              suspensionSpringConstant 1e+06
              suspensionDampingConstant 10000
            }
            endPoint DEF TRAILER Slot {
              type "truck trailer"
              endPoint IS trailer
            }
          }
        ]
      }
      TruckCab {
        color IS color
        sizeRatio %{= 1 + 0.239 * (wheelbase - 5.25) }%
      }
    ]
    radarCrossSection 200
    recognitionColors [
      %{= fields.color.value.r }% %{= fields.color.value.g }% %{= fields.color.value.b }%
    ]
    boundingObject Group {
      children [
        Transform {
          translation 0 2 %{= wheelbase + 0.15 }%
          children [
            Box {
              size 2.8 4.1 3.2
            }
          ]
        }
        Transform {
          translation 0 0.35 %{= 0.5 * wheelbase - 1.075 }%
          children [
            Box {
              size 2.8 0.8 %{= wheelbase - 0.75 }%
            }
          ]
        }
      ]
    }
    physics Physics {
      density -1
      mass IS mass
      centerOfMass [
        0 0.1 %{= wheelbase - 0.75 }%
      ]
    }
    wheelFrontLeft TruckWheel {
      name "front left wheel"
      physics DEF WHEEL_PHYSICS Physics {
        density -1
        mass 100
      }
    }
    wheelFrontRight TruckWheel {
      name "front right wheel"
      physics USE WHEEL_PHYSICS
    }
    wheelRearRight TruckWheel {
      name "rear right wheel"
      physics USE WHEEL_PHYSICS
    }
    wheelRearLeft TruckWheel {
      name "rear left wheel"
      physics USE WHEEL_PHYSICS
    }
    brakeCoefficient 5000
    %{ if fields.trailer.value then }%
      time0To100 25
    %{ else }%
      time0To100 18
    %{ end }%
  }
}
